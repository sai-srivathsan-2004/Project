name: OAS CI → Salt Analysis

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  BACKEND_DIR: Fast-Store-API/backend
  SALT_BASE: ${{ secrets.SALT_API_URL }}
  SALT_TOKEN: ${{ secrets.SALT_API_TOKEN }}

jobs:
  oas-ci:
    runs-on: ubuntu-latest

    steps:
    # -------------------------------------------------------
    # 1. CHECKOUT REPO
    # -------------------------------------------------------
    - name: Checkout
      uses: actions/checkout@v4

    # -------------------------------------------------------
    # 2. Setup Node
    # -------------------------------------------------------
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 18

    # -------------------------------------------------------
    # 3. Install backend deps
    # -------------------------------------------------------
    - name: Install backend dependencies
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        npm install

    # -------------------------------------------------------
    # 4. Generate OAS using swagger-autogen
    # -------------------------------------------------------
    - name: Generate OpenAPI (swagger-autogen)
      id: gen_oas
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        echo "Generating OAS..."

        # Install dependencies only if missing
        if ! node -e "require('swagger-autogen')" 2>/dev/null; then
          npm install swagger-autogen glob --save-dev
        fi

        # Run autodetection script
        if [ -f scripts/autodetect_generate_oas.js ]; then
          node scripts/autodetect_generate_oas.js
        else
          echo "❌ Missing scripts/autodetect_generate_oas.js"
          exit 1
        fi

        echo "Backend directory listing:"
        ls -la .

        if [ ! -f openapi.generated.json ]; then
          echo "❌ openapi.generated.json not found!"
          exit 1
        fi

        # No copy — use the file directly
        OAS_ABS="$GITHUB_WORKSPACE/${{ env.BACKEND_DIR }}/openapi.generated.json"
        echo "Using generated OAS at: $OAS_ABS"
        echo "oas_path=$OAS_ABS" >> $GITHUB_OUTPUT

    # -------------------------------------------------------
    # 5. Upload OAS to Salt
    # -------------------------------------------------------
    - name: Upload OAS to Salt
      id: upload
      run: |
        FILE="${{ steps.gen_oas.outputs.oas_path }}"
        echo "Uploading OAS file: $FILE"

        if [ ! -f "$FILE" ]; then
          echo "❌ OAS file does not exist at $FILE"
          exit 1
        fi

        RESPONSE=$(curl -s -X POST \
          "${{ env.SALT_BASE }}/oas/files" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -F "file=@${FILE}")

        echo "$RESPONSE" > oas_upload.json
        cat oas_upload.json

        OAS_ID=$(jq -r '.oasId // empty' oas_upload.json)

        if [ -z "$OAS_ID" ]; then
          echo "❌ Could not extract OAS ID"
          exit 1
        fi

        echo "oas_id=$OAS_ID" >> $GITHUB_OUTPUT

    # -------------------------------------------------------
    # 6. Trigger Design Analysis
    # -------------------------------------------------------
    - name: Trigger Design Analysis
      id: design
      run: |
        OAS_ID="${{ steps.upload.outputs.oas_id }}"
        echo "Triggering design analysis for OAS: $OAS_ID"

        RESPONSE=$(curl -s -X POST \
          "${{ env.SALT_BASE }}/oas/analyses/design?oasId=$OAS_ID" \
          -H "Authorization: Bearer $SALT_TOKEN")

        echo "$RESPONSE" > design_analysis.json
        cat design_analysis.json

        ANALYSIS_ID=$(jq -r '.analysisId // empty' design_analysis.json)

        if [ -z "$ANALYSIS_ID" ]; then
          echo "❌ Could not extract analysisId"
          exit 1
        fi

        echo "analysis_id=$ANALYSIS_ID" >> $GITHUB_OUTPUT

    # -------------------------------------------------------
    # 7. Fetch Design Results
    # -------------------------------------------------------
    - name: Fetch Design Results
      id: design_result
      run: |
        AID="${{ steps.design.outputs.analysis_id }}"
        echo "Fetching design results for analysis: $AID"

        RESPONSE=$(curl -s \
          "${{ env.SALT_BASE }}/oas/analyses/design/$AID" \
          -H "Authorization: Bearer $SALT_TOKEN")

        echo "$RESPONSE" > design_results.json
        jq '.' design_results.json > design_results_pretty.json

    # -------------------------------------------------------
    # 8. Commit results to repo
    # -------------------------------------------------------
    - name: Commit Reports to repo
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Salt Analysis Reports"
        branch: main
        file_pattern: |
          Fast-Store-API/backend/openapi.generated.json
          design_results.json
          design_results_pretty.json
        commit_user_name: github-actions[bot]
        commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
        push_options: '--force'
