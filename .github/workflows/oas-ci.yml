name: Salt OAS CI

on:
  push:
    branches: ["main"]

env:
  BACKEND_DIR: Fast-Store-API/backend

jobs:
  salt-oas:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Install backend dependencies
      working-directory: ${{ env.BACKEND_DIR }}
      run: npm install

    - name: Generate Swagger Autogen
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        npm install swagger-autogen glob --save-dev

        cat > autodetect_generate_oas.js <<'EOF'
        const glob = require("glob");
        const swaggerAutogen = require("swagger-autogen")();

        const files = glob.sync("**/*.js", {
          ignore: ["node_modules/**", "scripts/**"]
        });

        const entry = files.find(f => f.endsWith("index.js"));
        const core = entry ? ["./" + entry] : [];

        const outputFile = "./openapi.generated.json";

        const doc = {
          info: {
            title: "Fast Store API",
            description: "Auto-generated OAS"
          }
        };

        swaggerAutogen(outputFile, core, doc);
        EOF

        node autodetect_generate_oas.js

    - name: Verify OAS exists
      run: |
        FILE="${{ env.BACKEND_DIR }}/openapi.generated.json"
        echo "Checking: $FILE"
        if [ ! -f "$FILE" ]; then
          echo "❌ OAS not found!"
          exit 1
        fi
        ls -la "$FILE"

    - name: Base64 encode OAS
      id: encode
      run: |
        OAS="${{ env.BACKEND_DIR }}/openapi.generated.json"
        B64=$(base64 -w 0 "$OAS")
        echo "b64=$B64" >> $GITHUB_OUTPUT

    - name: Upload OAS to Salt
      id: upload
      env:
        SALT_API_TOKEN: ${{ secrets.SALT_API_TOKEN }}
        SALT_API_URL: ${{ secrets.SALT_API_URL }}
      run: |
        echo "Uploading OAS to Salt..."

        RESPONSE=$(curl -s -X POST "$SALT_API_URL/oas/files" \
          -H "Authorization: Bearer $SALT_API_TOKEN" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          --data-urlencode "name=faststore-oas" \
          --data-urlencode "file[]=${{ steps.encode.outputs.b64 }}" )

        echo "$RESPONSE" > oas_upload.json
        cat oas_upload.json

        OAS_ID=$(jq -r '.oasId // empty' oas_upload.json)

        if [ -z "$OAS_ID" ]; then
          echo "❌ ERROR: Upload failed"
          exit 1
        fi

        echo "oas_id=$OAS_ID" >> $GITHUB_OUTPUT

    - name: Commit generated OAS to main
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Add autogenerated OAS"
        file_pattern: ${{ env.BACKEND_DIR }}/openapi.generated.json
        branch: main
        commit_user_name: github-actions[bot]
        commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
        repository: .
        token: ${{ secrets.REPO_PAT }}
