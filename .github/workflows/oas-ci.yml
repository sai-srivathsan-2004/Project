name: OAS CI -> Salt Analysis

on:
  push:
    branches: [ "main" ]
  pull_request:

permissions:
  contents: write
  id-token: write

env:
  BACKEND_DIR: Fast-Store-API/backend
  OAS_CANDIDATES: "openapi.yaml openapi.yml openapi.json swagger.yaml swagger.yml swagger.json api/openapi.yaml api/openapi.json"

jobs:
  oas-test:
    runs-on: ubuntu-latest

    steps:
    # -------------------------------------------------------
    # 1. CHECKOUT
    # -------------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # -------------------------------------------------------
    # 2. RUNTIMES
    # -------------------------------------------------------
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # -------------------------------------------------------
    # DEBUG STRUCTURE
    # -------------------------------------------------------
    - name: Print directory structure
      run: ls -R .

    # -------------------------------------------------------
    # 3. INSTALL BACKEND DEPENDENCIES
    # -------------------------------------------------------
    - name: Install backend dependencies
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        if [ -f package.json ]; then
          echo "Installing backend dependencies..."
          npm ci || npm install
        else
          echo "No package.json in backend â€” skipping install"
        fi

    # -------------------------------------------------------
    # 4. DETECT EXISTING OAS
    # -------------------------------------------------------
    - name: Detect OAS file
      id: detect_oas
      run: |
        FOUND=""
        for f in $OAS_CANDIDATES; do
          FILE=$(find . -type f -iname "$f" | head -n1 || true)
          if [ -n "$FILE" ]; then
            FOUND="$FILE"
            break
          fi
        done

        if [ -n "$FOUND" ]; then
          echo "found=true" >> $GITHUB_OUTPUT
          echo "path=$FOUND" >> $GITHUB_OUTPUT
          echo "Found OAS: $FOUND"
        else
          echo "found=false" >> $GITHUB_OUTPUT
          echo "path=" >> $GITHUB_OUTPUT
          echo "No OAS found."
        fi

    # -------------------------------------------------------
    # 5. GENERATE OAS IF NOT FOUND
    # -------------------------------------------------------
    - name: Generate OAS using swagger-autogen
      if: steps.detect_oas.outputs.found == 'false'
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        npm install -g swagger-autogen

        mkdir -p scripts

        cat > scripts/generate_oas.js <<'EOF'
        const swaggerAutogen = require('swagger-autogen')();
        const outputFile = './openapi.generated.json';
        const endpointsFiles = [
          './index.js',
          './app.js',
          './server.js',
          './routes.js',
          './routes/index.js'
        ];
        const doc = {
          info: { title: 'Fast-Store-API (Generated)', description: 'Auto-generated OAS' }
        };
        swaggerAutogen(outputFile, endpointsFiles, doc);
        EOF

        node scripts/generate_oas.js || true

        if [ -f openapi.generated.json ]; then
          echo "found=true" >> $GITHUB_OUTPUT
          echo "path=${{ env.BACKEND_DIR }}/openapi.generated.json" >> $GITHUB_OUTPUT
        else
          echo "found=false" >> $GITHUB_OUTPUT
        fi

    # -------------------------------------------------------
    # 6. CHOOSE FINAL OAS FILE
    # -------------------------------------------------------
    - name: Determine final OAS file
      id: final_oas
      run: |
        if [ "${{ steps.detect_oas.outputs.found }}" == "true" ]; then
          echo "oas_path=${{ steps.detect_oas.outputs.path }}" >> $GITHUB_OUTPUT
        else
          echo "oas_path=${{ env.BACKEND_DIR }}/openapi.generated.json" >> $GITHUB_OUTPUT
        fi

        echo "Final OAS path: ${{ steps.final_oas.outputs.oas_path }}"

    # -------------------------------------------------------
    # 7. LINT OAS WITH SPECTRAL
    # -------------------------------------------------------
    - name: Lint OAS with Spectral
      if: steps.final_oas.outputs.oas_path != ''
      run: |
        npm install -g @stoplight/spectral-cli
        spectral lint "${{ steps.final_oas.outputs.oas_path }}" || true

    # -------------------------------------------------------
    # 8. UPLOAD TO SALT
    # -------------------------------------------------------
    - name: Upload to Salt API
      id: salt_upload
      if: steps.final_oas.outputs.oas_path != ''
      env:
        SALT_API_URL: ${{ secrets.SALT_API_URL }}
        SALT_API_TOKEN: ${{ secrets.SALT_API_TOKEN }}
      run: |
        FILE="${{ steps.final_oas.outputs.oas_path }}"

        RESPONSE=$(curl -s -X POST "$SALT_API_URL/api/v1/oas/upload" \
          -H "Authorization: Bearer $SALT_API_TOKEN" \
          -F "file=@${FILE}")

        echo "$RESPONSE" > salt_upload_resp.json
        JOBID=$(jq -r '.job_id // .id // empty' salt_upload_resp.json)

        echo "job_id=$JOBID" >> $GITHUB_OUTPUT

    # -------------------------------------------------------
    # 9. POLL SALT UNTIL READY
    # -------------------------------------------------------
    - name: Poll Salt job
      id: salt_poll
      if: steps.salt_upload.outputs.job_id != ''
      env:
        SALT_API_URL: ${{ secrets.SALT_API_URL }}
        SALT_API_TOKEN: ${{ secrets.SALT_API_TOKEN }}
      run: |
        JOB=${{ steps.salt_upload.outputs.job_id }}

        for i in $(seq 1 30); do
          STATUS=$(curl -s \
            -H "Authorization: Bearer $SALT_API_TOKEN" \
            "$SALT_API_URL/api/v1/oas/jobs/$JOB/status" | jq -r '.status // .state // empty')

          if [[ "$STATUS" == "finished" || "$STATUS" == "completed" ]]; then
            curl -s \
              -H "Authorization: Bearer $SALT_API_TOKEN" \
              "$SALT_API_URL/api/v1/oas/jobs/$JOB/export?format=csv" \
              -o salt_oas_result.csv
            break
          fi

          sleep 10
        done

    # -------------------------------------------------------
    # 10. CHECK CSV EXISTS
    # -------------------------------------------------------
    - name: Check CSV existence
      id: check_csv
      run: |
        if [ -f salt_oas_result.csv ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    # -------------------------------------------------------
    # 11. COMMIT REPORT TO "reports" BRANCH
    # -------------------------------------------------------
    - name: Commit CSV to reports branch
      if: steps.check_csv.outputs.exists == 'true'
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Salt OAS Analysis CSV for ${{ github.sha }}"
        file_pattern: "salt_oas_result.csv"
        branch: reports
        author_name: OAS-CI
        author_email: ci-bot@example.com
