name: OAS CI + Salt Analysis Pipeline

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

env:
  BACKEND_DIR: Fast-Store-API/backend
  SALT_BASE: ${{ secrets.SALT_API_URL }}
  SALT_TOKEN: ${{ secrets.SALT_API_TOKEN }}

jobs:
  salt-oas:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # ------------------------------------------
      # 1. Checkout
      # ------------------------------------------
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # ------------------------------------------
      # 2. Install dependencies (backend)
      # ------------------------------------------
      - name: Install Backend Dependencies
        working-directory: ${{ env.BACKEND_DIR }}
        run: |
          if [ -f package.json ]; then
            npm ci || npm install
          fi

      # ------------------------------------------
      # 3. AUTO-DETECT EXPRESS ROUTES + GENERATE OAS
      # ------------------------------------------
      - name: Install swagger-autogen
        run: npm install -g swagger-autogen glob

      - name: Generate OAS Auto
        id: gen_oas
        working-directory: ${{ env.BACKEND_DIR }}
        run: |
          mkdir -p scripts

          cat > scripts/autogen.js <<'EOF'
          const glob = require('glob');
          const swaggerAutogen = require('swagger-autogen')();

          const files = glob.sync("**/*.js", {
            ignore: ["node_modules/**", "scripts/**", "**/*.test.js"]
          });

          // Express heuristics
          const core = [];
          const pref = ["index.js", "app.js", "routes/index.js"];
          for (const p of pref) {
            const f = files.find(x => x.endsWith(p));
            if (f) core.push("./" + f);
          }

          // Add additional express/router files
          for (const f of files) {
            if (core.length >= 20) break;
            if (/route|router|express/.test(f) && !core.includes("./" + f)) {
              core.push("./" + f);
            }
          }

          if (core.length === 0) {
            const idx = files.find(f => f.endsWith("index.js"));
            if (idx) core.push("./" + idx);
          }

          console.log("Detected files:", core);

          const outputFile = "./openapi.generated.json";
          const doc = { info: { title: "Fast Store API", description: "Autogenerated OAS" } };

          swaggerAutogen(outputFile, core, doc).then(() => {
            console.log("Swagger OAS generated");
          });
          EOF

          node scripts/autogen.js

          if [ -f openapi.generated.json ]; then
            echo "oas_path=${{ env.BACKEND_DIR }}/openapi.generated.json" >> $GITHUB_OUTPUT
          else
            echo "oas_path=" >> $GITHUB_OUTPUT
          fi

      # ------------------------------------------
      # 4. Upload OAS → POST /v1/oas/files
      # ------------------------------------------
      - name: Upload OAS to Salt
        id: oas_upload
        if: steps.gen_oas.outputs.oas_path != ''
        run: |
          FILE="${{ steps.gen_oas.outputs.oas_path }}"

          RESP=$(curl -s -w "\n%{http_code}" -X POST "$SALT_BASE/v1/oas/files" \
            -H "Authorization: Bearer $SALT_TOKEN" \
            -H "accept: application/json" \
            -F "name=faststore-oas-${GITHUB_SHA::7}" \
            -F "file[]=@${FILE}")

          STATUS=$(echo "$RESP" | tail -n1)
          BODY=$(echo "$RESP" | sed '$d')
          echo "$BODY" > oas_upload.json

          OASID=$(jq -r '.oasId // .oasID // .id // empty' oas_upload.json)

          echo "oas_id=$OASID" >> $GITHUB_OUTPUT

      # ------------------------------------------
      # 5. Trigger Design Analysis
      # POST /v1/oas/analyses/design?oasId=xxx
      # ------------------------------------------
      - name: Trigger Design Analysis
        id: design_trigger
        if: steps.oas_upload.outputs.oas_id != ''
        run: |
          OASID="${{ steps.oas_upload.outputs.oas_id }}"

          RESP=$(curl -s -w "\n%{http_code}" -X POST \
            "$SALT_BASE/v1/oas/analyses/design?oasId=$OASID" \
            -H "Authorization: Bearer $SALT_TOKEN" \
            -H "accept: application/json")

          STATUS=$(echo "$RESP" | tail -n1)
          BODY=$(echo "$RESP" | sed '$d')
          echo "$BODY" > design_trigger.json

          DID=$(jq -r '.analysisId // .id // empty' design_trigger.json)

          echo "design_id=$DID" >> $GITHUB_OUTPUT

      # ------------------------------------------
      # 6. Fetch Design Analysis Results
      # GET /v1/oas/analyses/design/{analysisId}
      # ------------------------------------------
      - name: Fetch Design Results
        if: steps.design_trigger.outputs.design_id != ''
        run: |
          DID="${{ steps.design_trigger.outputs.design_id }}"

          curl -s \
            -H "Authorization: Bearer $SALT_TOKEN" \
            "$SALT_BASE/v1/oas/analyses/design/$DID?limit=500&offset=0&reverse=false&statsOnly=false" \
            > design_results.json

          jq '.' design_results.json > design_results_pretty.json

      # ------------------------------------------
      # 7. Trigger Drift Analysis
      # POST /v1/oas/analyses/drift?apiId=X&oasId=Y
      # Needs apiId → try reading from upload JSON if present
      # ------------------------------------------
      - name: Trigger Drift Analysis
        id: drift_trigger
        if: steps.oas_upload.outputs.oas_id != ''
        run: |
          OASID="${{ steps.oas_upload.outputs.oas_id }}"

          APIID=$(jq -r '.apiId // .apiID // .data.apiId // empty' oas_upload.json || true)

          if [ -z "$APIID" ]; then
            echo "drift_id=" >> $GITHUB_OUTPUT
            exit 0
          fi

          RESP=$(curl -s -w "\n%{http_code}" -X POST \
            "$SALT_BASE/v1/oas/analyses/drift?apiId=$APIID&oasId=$OASID" \
            -H "Authorization: Bearer $SALT_TOKEN")

          BODY=$(echo "$RESP" | sed '$d')
          echo "$BODY" > drift_trigger.json

          DID=$(jq -r '.analysisId // .id // empty' drift_trigger.json)
          echo "drift_id=$DID" >> $GITHUB_OUTPUT

      # ------------------------------------------
      # 8. Fetch Drift Results
      # GET /v1/oas/analyses/drift/{analysisId}
      # ------------------------------------------
      - name: Fetch Drift Results
        if: steps.drift_trigger.outputs.drift_id != ''
        run: |
          DID="${{ steps.drift_trigger.outputs.drift_id }}"
          APIID=$(jq -r '.apiId // .id // empty' oas_upload.json || true)

          curl -s \
            -H "Authorization: Bearer $SALT_TOKEN" \
            "$SALT_BASE/v1/oas/analyses/drift/$DID?apiId=$APIID&statsOnly=false" \
            > drift_results.json

          jq '.' drift_results.json > drift_results_pretty.json

      # ------------------------------------------
      # 9. Save results and commit to branch
      # ------------------------------------------
      - name: Prepare Reports
        run: |
          mkdir -p reports
          cp -f oas_upload.json reports/ 2>/dev/null || true
          cp -f design_results_pretty.json reports/ 2>/dev/null || true
          cp -f drift_results_pretty.json reports/ 2>/dev/null || true

      - name: Commit Reports
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Salt OAS Analysis results for ${{ github.sha }}"
          file_pattern: "reports/*"
          branch: reports
          author_name: OAS-CI
          author_email: ci-bot@example.com
