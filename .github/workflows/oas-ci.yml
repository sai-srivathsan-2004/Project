name: OAS Salt CI

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  BACKEND_DIR: Fast-Store-API/backend
  SALT_BASE: https://api.secured-api.com/v1
  SALT_TOKEN: ${{ secrets.SALT_API_TOKEN }}

jobs:
  salt-oas:
    runs-on: ubuntu-latest

    steps:
    # -----------------------------
    # 1) CHECKOUT
    # -----------------------------
    - name: Checkout Repo
      uses: actions/checkout@v4

    # -----------------------------
    # 2) NODE SETUP
    # -----------------------------
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    # -----------------------------
    # 3) INSTALL BACKEND DEPS
    # -----------------------------
    - name: Install Backend Dependencies
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        if [ -f package.json ]; then
          npm ci || npm install
        fi

    # -----------------------------
    # 4) INSTALL swagger-autogen
    # -----------------------------
    - name: Install swagger-autogen
      run: npm install -g swagger-autogen glob

    # -----------------------------
    # 5) AUTO-GENERATE OAS
    # -----------------------------
    - name: Generate OAS Automatically
      id: gen
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        mkdir -p scripts

        cat << 'EOF' > scripts/autogen.js
        const glob = require('glob');
        const swaggerAutogen = require('swagger-autogen')();

        const files = glob.sync("**/*.js", {
          ignore: ["node_modules/**", "scripts/**", "**/*.test.js"]
        });

        const core = [];
        const pref = ["index.js", "app.js", "routes/index.js"];
        for (const p of pref) {
          const f = files.find(x => x.endsWith(p));
          if (f) core.push("./" + f);
        }

        for (const f of files) {
          if (core.length >= 20) break;
          if (/route|router|express/.test(f) && !core.includes("./" + f)) {
            core.push("./" + f);
          }
        }

        if (core.length === 0) {
          const idx = files.find(f => f.endsWith("index.js"));
          if (idx) core.push("./" + idx);
        }

        console.log("Detected files:", core);

        const doc = {
          info: { title: "Fast Store API", description: "Autogenerated OAS" }
        };
        swaggerAutogen("./openapi.generated.json", core, doc).then(() => {
          console.log("Swagger OAS generated");
        });
        EOF

            node scripts/autogen.js

            echo "oas_path=$(pwd)/openapi.generated.json" >> $GITHUB_OUTPUT

    # -----------------------------
    # 6) COMMIT OAS INTO MAIN BRANCH
    # -----------------------------
    - name: Commit OAS File
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Auto-generated OAS"
        file_pattern: Fast-Store-API/backend/openapi.generated.json
        branch: main

    # -----------------------------
    # 7) UPLOAD OAS TO SALT
    # -----------------------------
    - name: Upload OAS to Salt
      id: upload
      run: |
        OAS_FILE="${{ steps.gen.outputs.oas_path }}"
        echo "Uploading: $OAS_FILE"

        curl -v -X POST "$SALT_BASE/oas/files" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -H "accept: application/json" \
          -F "name=faststore-oas" \
          -F "file[]=@${OAS_FILE}" \
          -o oas_upload.json

        cat oas_upload.json

        OAS_ID=$(jq -r '.oasId // .id // empty' oas_upload.json)
        echo "oas_id=$OAS_ID" >> $GITHUB_OUTPUT

    # -----------------------------
    # 8) TRIGGER DESIGN ANALYSIS
    # -----------------------------
    - name: Trigger Design Analysis
      id: design
      run: |
        OAS_ID="${{ steps.upload.outputs.oas_id }}"

        curl -s -X POST "$SALT_BASE/oas/analyses/design?oasId=$OAS_ID" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -d '{}' \
          -o design_trigger.json

        DESIGN_ID=$(jq -r '.analysisId // .id // empty' design_trigger.json)
        echo "design_id=$DESIGN_ID" >> $GITHUB_OUTPUT

        cat design_trigger.json

    # -----------------------------
    # 9) FETCH DESIGN RESULTS
    # -----------------------------
    - name: Fetch Design Results
      run: |
        DESIGN_ID="${{ steps.design.outputs.design_id }}"

        curl -s "$SALT_BASE/oas/analyses/design/$DESIGN_ID?limit=0&offset=0&statsOnly=false" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -o design_results.json

        jq '.' design_results.json > design_results_pretty.json

    # -----------------------------
    # 10) TRIGGER DRIFT ANALYSIS
    # -----------------------------
    - name: Trigger Drift Analysis
      id: drift
      run: |
        OAS_ID="${{ steps.upload.outputs.oas_id }}"
        API_ID="faststore"      

        curl -s -X POST "$SALT_BASE/oas/analyses/drift?apiId=$API_ID&oasId=$OAS_ID" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -o drift_trigger.json

        DRIFT_ID=$(jq -r '.analysisId // .id // empty' drift_trigger.json)
        echo "drift_id=$DRIFT_ID" >> $GITHUB_OUTPUT

        cat drift_trigger.json

    # -----------------------------
    # 11) FETCH DRIFT RESULTS
    # -----------------------------
    - name: Fetch Drift Results
      run: |
        DRIFT_ID="${{ steps.drift.outputs.drift_id }}"
        API_ID="faststore"

        curl -s "$SALT_BASE/oas/analyses/drift/$DRIFT_ID?apiId=$API_ID&statsOnly=false" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -o drift_results.json

        jq '.' drift_results.json > drift_results_pretty.json

    # -----------------------------
    # 12) PACKAGE REPORTS
    # -----------------------------
    - name: Prepare Reports
      run: |
        mkdir -p reports
        cp -f oas_upload.json reports/
        cp -f design_results_pretty.json reports/
        cp -f drift_results_pretty.json reports/
        ls -R reports

    # -----------------------------
    # 13) COMMIT REPORTS TO reports BRANCH
    # -----------------------------
    - name: Commit Reports
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Salt OAS Analysis Reports"
        file_pattern: "reports/*"
        branch: reports
