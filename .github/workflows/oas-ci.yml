name: OAS CI Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  BACKEND_DIR: Fast-Store-API/backend
  SALT_BASE: https://api.secured-api.com/v1
  SALT_TOKEN: ${{ secrets.SALT_TOKEN }}
  REPO_PAT: ${{ secrets.REPO_PAT }}

jobs:
  oas-ci:
    runs-on: ubuntu-latest

    steps:
    # ------------------------ CHECKOUT -----------------------------------
    - name: Checkout Repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.REPO_PAT }}
        fetch-depth: 0

    # ------------------------ SETUP NODE ---------------------------------
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Install backend dependencies
      working-directory: ${{ env.BACKEND_DIR }}
      run: npm install

    # ------------------------ GENERATE OAS --------------------------------
    - name: Generate OpenAPI (Swagger Autogen)
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        npm install swagger-autogen glob --save-dev

        cat > scripts/autogen.js << 'EOF'
        const glob = require('glob');
        const swaggerAutogen = require('swagger-autogen')();

        const routes = glob.sync("./routes/**/*.js", { cwd: "." });

        const doc = {
          info: {
            title: "Fast Store API",
            description: "Autogenerated OpenAPI Spec"
          }
        };

        const outputFile = "./openapi.generated.json";

        swaggerAutogen(outputFile, routes, doc).then(() => {
          console.log("OpenAPI Generated Successfully");
        });
        EOF

        node scripts/autogen.js

        echo "--- Generated OAS file ---"
        ls -l openapi.generated.json

    # ------------------------ UPLOAD OAS TO SALT --------------------------
    - name: Upload OAS to Salt
      id: upload
      run: |
        set -e

        OAS_FILE="${BACKEND_DIR}/openapi.generated.json"
        echo "Uploading OAS file: $OAS_FILE"

        if [ ! -f "$OAS_FILE" ]; then
          echo "❌ OAS file not found!"
          exit 1
        fi

        # Base64 encode for form upload (Salt requires file[] encoded)
        B64=$(base64 -w 0 "$OAS_FILE")

        STATUS=$(curl -s -w "%{http_code}" -o oas_upload.json \
          -X POST "$SALT_BASE/oas/files" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          --data-urlencode "name=faststore-oas" \
          --data-urlencode "file[]=$B64")

        echo "HTTP STATUS: $STATUS"
        echo "Salt Upload Response:"
        cat oas_upload.json || true

        if [ "$STATUS" != "200" ]; then
          echo "❌ Salt returned non-200 response"
          exit 1
        fi

        OAS_ID=$(jq -r '.oasId // empty' oas_upload.json)
        if [ -z "$OAS_ID" ]; then
          echo "❌ Could not extract OAS ID"
          exit 1
        fi

        echo "✔ OAS ID: $OAS_ID"
        echo "oas_id=$OAS_ID" >> "$GITHUB_OUTPUT"

    # ------------------------ TRIGGER DESIGN ANALYSIS ---------------------
    - name: Trigger Design Analysis
      id: design
      run: |
        OAS_ID="${{ steps.upload.outputs.oas_id }}"

        STATUS=$(curl -s -w "%{http_code}" -o design_trigger.json \
          -X POST "$SALT_BASE/oas/analyses/design?oasId=$OAS_ID" \
          -H "Authorization: Bearer $SALT_TOKEN")

        echo "HTTP STATUS: $STATUS"
        cat design_trigger.json

        if [ "$STATUS" != "200" ]; then
          echo "❌ Failed to trigger design analysis"
          exit 1
        fi

        ANALYSIS_ID=$(jq -r '.analysisId // empty' design_trigger.json)

        if [ -z "$ANALYSIS_ID" ]; then
          echo "❌ Could not parse analysisId"
          exit 1
        fi

        echo "analysis_id=$ANALYSIS_ID" >> "$GITHUB_OUTPUT"

    # ------------------------ FETCH DESIGN RESULTS ------------------------
    - name: Fetch Design Results
      run: |
        AID="${{ steps.design.outputs.analysis_id }}"

        curl -s "$SALT_BASE/oas/analyses/design/$AID?statsOnly=false" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -o design_results.json

        cat design_results.json | jq '.' > design_results_pretty.json

    # ------------------------ TRIGGER DRIFT ANALYSIS ----------------------
    - name: Trigger Drift Analysis
      id: drift
      run: |
        OAS_ID="${{ steps.upload.outputs.oas_id }}"
        API_ID="faststore-backend"  # Replace with your actual API ID in Salt

        STATUS=$(curl -s -w "%{http_code}" -o drift_trigger.json \
          -X POST "$SALT_BASE/oas/analyses/drift?oasId=$OAS_ID&apiId=$API_ID" \
          -H "Authorization: Bearer $SALT_TOKEN")

        echo "HTTP STATUS: $STATUS"
        cat drift_trigger.json

        if [ "$STATUS" != "200" ]; then
          echo "❌ Failed to trigger drift analysis"
          exit 1
        fi

        DRIFT_ID=$(jq -r '.analysisId // empty' drift_trigger.json)

        echo "drift_id=$DRIFT_ID" >> "$GITHUB_OUTPUT"

    # ------------------------ FETCH DRIFT RESULTS -------------------------
    - name: Fetch Drift Results
      run: |
        DID="${{ steps.drift.outputs.drift_id }}"

        curl -s "$SALT_BASE/oas/analyses/drift/$DID?statsOnly=false" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -o drift_results.json

        cat drift_results.json | jq '.' > drift_results_pretty.json

    # ------------------------ COMMIT OAS + REPORTS -----------------------
    - name: Commit Results to Repo
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        token: ${{ env.REPO_PAT }}
        branch: main
        commit_message: "Update OAS + Salt Analysis Results"
        file_pattern: |
          Fast-Store-API/backend/openapi.generated.json
          *.json
