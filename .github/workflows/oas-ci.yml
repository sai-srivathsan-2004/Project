name: salt-oas

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  BACKEND_DIR: Fast-Store-API/backend
  SALT_BASE: https://api.secured-api.com/v1
  SALT_TOKEN: ${{ secrets.SALT_API_TOKEN }}

jobs:
  salt-oas:
    runs-on: ubuntu-latest

    steps:

    # -------------------------------
    # CHECKOUT
    # -------------------------------
    - name: Checkout Repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    # -------------------------------
    # SETUP NODE
    # -------------------------------
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    # -------------------------------
    # INSTALL BACKEND DEPENDENCIES
    # -------------------------------
    - name: Install Backend Dependencies
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        if [ -f package.json ]; then
          npm ci || npm install
        fi

    # -------------------------------
    # INSTALL swagger-autogen
    # -------------------------------
    - name: Install swagger-autogen
      run: npm install -g swagger-autogen glob

    # -------------------------------
    # GENERATE OAS AUTOMATICALLY
    # -------------------------------
    - name: Generate OAS Auto
      id: autogen
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        mkdir -p scripts

        cat > scripts/autogen.js <<'EOF'
const glob = require('glob');
const swaggerAutogen = require('swagger-autogen')();

const files = glob.sync("**/*.js", {
  ignore: ["node_modules/**", "scripts/**", "**/*.test.js"]
});

const core = [];
const pref = ["index.js", "app.js", "routes/index.js"];
for (const p of pref) {
  const f = files.find(x => x.endsWith(p));
  if (f) core.push("./" + f);
}

for (const f of files) {
  if (core.length >= 20) break;
  if (/route|router|express/.test(f) && !core.includes("./" + f)) {
    core.push("./" + f);
  }
}

if (core.length === 0) {
  const idx = files.find(f => f.endsWith("index.js"));
  if (idx) core.push("./" + idx);
}

console.log("Detected files:", core);

const outputFile = "./openapi.generated.json";
const doc = { info: { title: "Fast Store API", description: "Autogenerated OAS" } };

swaggerAutogen(outputFile, core, doc).then(() => {
  console.log("Swagger OAS generated");
});
EOF

        node scripts/autogen.js

        # Correct ABSOLUTE path to avoid Salt upload failure
        if [ -f openapi.generated.json ]; then
          echo "oas_path=$(pwd)/openapi.generated.json" >> $GITHUB_OUTPUT
        else
          echo "oas_path=" >> $GITHUB_OUTPUT
        fi

    # -------------------------------
    # COMMIT GENERATED OAS TO MAIN
    # -------------------------------
    - name: Commit OAS File to main
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Add autogenerated OAS"
        file_pattern: Fast-Store-API/backend/openapi.generated.json
        branch: main

    # -------------------------------
    # UPLOAD OAS TO SALT
    # -------------------------------
    - name: Upload OAS to Salt
      id: upload
      run: |
        OAS="${{ steps.autogen.outputs.oas_path }}"

        curl -s -X POST "${{ env.SALT_BASE }}/oas/files" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -H "accept: application/json" \
          -F "name=faststore-oas" \
          -F "file[][file]=@${OAS}" \
          -o oas_upload.json

        cat oas_upload.json

    # -------------------------------
    # TRIGGER DESIGN ANALYSIS
    # -------------------------------
    - name: Trigger Design Analysis
      id: design
      run: |
        OAS_ID=$(jq -r '.oasId' oas_upload.json)

        curl -s -X POST "${{ env.SALT_BASE }}/oas/analyses/design?oasId=${OAS_ID}" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -H "Content-Type: application/json" \
          -d '{}' \
          -o design_trigger.json

        DESIGN_ID=$(jq -r '.analysisId' design_trigger.json)
        echo "design_id=$DESIGN_ID" >> $GITHUB_OUTPUT

    # -------------------------------
    # FETCH DESIGN RESULTS
    # -------------------------------
    - name: Fetch Design Results
      run: |
        curl -s "${{ env.SALT_BASE }}/oas/analyses/design/${{ steps.design.outputs.design_id }}?limit=0&offset=0&statsOnly=true" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -o design_results.json

        jq '.' design_results.json > design_results_pretty.json

    # -------------------------------
    # TRIGGER DRIFT ANALYSIS
    # -------------------------------
    - name: Trigger Drift Analysis
      id: drift
      run: |
        OAS_ID=$(jq -r '.oasId' oas_upload.json)

        curl -s -X POST "${{ env.SALT_BASE }}/oas/analyses/drift?apiId=faststore&oasId=${OAS_ID}" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -o drift_trigger.json

        DRIFT_ID=$(jq -r '.analysisId' drift_trigger.json)
        echo "drift_id=$DRIFT_ID" >> $GITHUB_OUTPUT

    # -------------------------------
    # FETCH DRIFT RESULTS
    # -------------------------------
    - name: Fetch Drift Results
      run: |
        curl -s "${{ env.SALT_BASE }}/oas/analyses/drift/${{ steps.drift.outputs.drift_id }}?apiId=faststore&statsOnly=true" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -o drift_results.json

        jq '.' drift_results.json > drift_results_pretty.json

    # -------------------------------
    # PACKAGE REPORTS
    # -------------------------------
    - name: Prepare Reports
      run: |
        mkdir -p reports
        cp -f oas_upload.json reports/ || true
        cp -f design_results_pretty.json reports/ || true
        cp -f drift_results_pretty.json reports/ || true

    # -------------------------------
    # COMMIT REPORTS TO reports BRANCH
    # -------------------------------
    - name: Commit Reports
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Salt OAS Analysis results"
        file_pattern: reports/*
        branch: reports
