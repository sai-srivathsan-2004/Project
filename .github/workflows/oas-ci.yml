name: OAS CI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  BACKEND_DIR: Fast-Store-API/backend
  SALT_BASE: https://api.secured-api.com/v1
  SALT_TOKEN: ${{ secrets.SALT_API_TOKEN }}
  REPO_PAT: ${{ secrets.REPO_PAT }}

jobs:
  oas-ci:
    runs-on: ubuntu-latest

    steps:
    # ------------------------ 1. CHECKOUT ------------------------
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ env.REPO_PAT }}

    # ------------------------ 2. NODE SETUP ----------------------
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    # ------------------------ 3. INSTALL BACKEND DEPS ------------
    - name: Install backend dependencies
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        if [ -f package-lock.json ]; then
          npm ci
        else
          npm install
        fi

    # ------------------------ 4. GENERATE OAS --------------------
    # Assumes you have a generator script in Fast-Store-API/backend/scripts/autogen.js
    # that writes ./openapi.generated.json in BACKEND_DIR
    - name: Generate OpenAPI (swagger-autogen)
      id: gen_oas
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        # If swagger-autogen isn't a project dependency, install locally
        if ! node -e "require('swagger-autogen')" 2>/dev/null; then
          npm install swagger-autogen glob --save-dev
        fi

        if [ -f scripts/autogen.js ]; then
          echo "Running existing scripts/autogen.js"
          node scripts/autogen.js
        elif [ -f scripts/autodetect_generate_oas.js ]; then
          echo "Running existing scripts/autodetect_generate_oas.js"
          node scripts/autodetect_generate_oas.js
        else
          echo "No autogen script found. Create scripts/autogen.js or scripts/autodetect_generate_oas.js"
          exit 1
        fi

        echo "Backend directory listing:"
        ls -la .

        if [ ! -f openapi.generated.json ]; then
          echo "❌ openapi.generated.json was not generated in $PWD"
          exit 1
        fi

        OAS_ABS="$GITHUB_WORKSPACE/${{ env.BACKEND_DIR }}/openapi.generated.json"
        echo "Copying generated OAS to $OAS_ABS"
        cp openapi.generated.json "$OAS_ABS"

        echo "oas_path=$OAS_ABS" >> $GITHUB_OUTPUT

    # ------------------------ 5. VERIFY OAS ----------------------
    - name: Verify OAS file
      run: |
        FILE="${{ steps.gen_oas.outputs.oas_path }}"
        echo "Verifying OAS at: $FILE"
        ls -l "$FILE"
        head -c 200 "$FILE" || true

    # ------------------------ 6. UPLOAD TO SALT ------------------
    - name: Upload OAS to Salt
      id: upload
      run: |
        set -e

        OAS_FILE="${{ steps.gen_oas.outputs.oas_path }}"
        echo "Uploading OAS file: $OAS_FILE"

        if [ ! -f "$OAS_FILE" ]; then
          echo "❌ OAS file not found!"
          exit 1
        fi

        # Encode file content as base64 for application/x-www-form-urlencoded
        B64=$(base64 -w 0 "$OAS_FILE")

        STATUS=$(curl -s -w "%{http_code}" -o oas_upload.json \
          -X POST "$SALT_BASE/oas/files" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -H "accept: application/json" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          --data-urlencode "name=faststore-oas" \
          --data-urlencode "file[]=$B64")

        echo "HTTP STATUS: $STATUS"
        echo "Salt upload raw response:"
        cat oas_upload.json || true
        echo

        if [ "$STATUS" != "200" ]; then
          echo "❌ Salt returned non-200 status"
          exit 1
        fi

        # If Salt returns success:false, stop here and show error clearly
        if jq -e '.success == false' oas_upload.json > /dev/null 2>&1; then
          echo "❌ Salt reported failure while uploading OAS:"
          cat oas_upload.json
          exit 1
        fi

        OAS_ID=$(jq -r '.oasId // .id // empty' oas_upload.json)
        if [ -z "$OAS_ID" ]; then
          echo "❌ Could not extract oasId from Salt response"
          exit 1
        fi

        echo "✔ OAS ID: $OAS_ID"
        echo "oas_id=$OAS_ID" >> $GITHUB_OUTPUT

    # ------------------------ 7. TRIGGER DESIGN ANALYSIS ---------
    - name: Trigger Design Analysis
      id: design
      run: |
        set -e
        OAS_ID="${{ steps.upload.outputs.oas_id }}"

        STATUS=$(curl -s -w "%{http_code}" -o design_trigger.json \
          -X POST "$SALT_BASE/oas/analyses/design?oasId=$OAS_ID" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -H "accept: application/json")

        echo "HTTP STATUS (design trigger): $STATUS"
        cat design_trigger.json || true

        if [ "$STATUS" != "200" ]; then
          echo "❌ Failed to trigger design analysis"
          exit 1
        fi

        DESIGN_ID=$(jq -r '.analysisId // .id // empty' design_trigger.json)
        if [ -z "$DESIGN_ID" ]; then
          echo "❌ Could not parse design analysisId"
          exit 1
        fi

        echo "design_id=$DESIGN_ID" >> $GITHUB_OUTPUT

    # ------------------------ 8. FETCH DESIGN RESULTS ------------
    - name: Fetch Design Results
      run: |
        set -e
        DESIGN_ID="${{ steps.design.outputs.design_id }}"

        STATUS=$(curl -s -w "%{http_code}" -o design_results.json \
          "$SALT_BASE/oas/analyses/design/$DESIGN_ID?statsOnly=false" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -H "accept: application/json")

        echo "HTTP STATUS (design results): $STATUS"
        cat design_results.json || true
        jq '.' design_results.json > design_results_pretty.json || true

    # ------------------------ 9. TRIGGER DRIFT ANALYSIS ----------
    - name: Trigger Drift Analysis
      id: drift
      run: |
        set -e
        OAS_ID="${{ steps.upload.outputs.oas_id }}"
        API_ID="faststore-backend"  # TODO: replace with your actual Salt API ID

        STATUS=$(curl -s -w "%{http_code}" -o drift_trigger.json \
          -X POST "$SALT_BASE/oas/analyses/drift?oasId=$OAS_ID&apiId=$API_ID" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -H "accept: application/json")

        echo "HTTP STATUS (drift trigger): $STATUS"
        cat drift_trigger.json || true

        if [ "$STATUS" != "200" ]; then
          echo "❌ Failed to trigger drift analysis"
          exit 1
        fi

        DRIFT_ID=$(jq -r '.analysisId // .id // empty' drift_trigger.json)
        echo "drift_id=$DRIFT_ID" >> $GITHUB_OUTPUT

    # ------------------------ 10. FETCH DRIFT RESULTS ------------
    - name: Fetch Drift Results
      if: steps.drift.outputs.drift_id != ''
      run: |
        set -e
        DRIFT_ID="${{ steps.drift.outputs.drift_id }}"
        API_ID="faststore-backend"  # same as above

        STATUS=$(curl -s -w "%{http_code}" -o drift_results.json \
          "$SALT_BASE/oas/analyses/drift/$DRIFT_ID?apiId=$API_ID&statsOnly=false" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -H "accept: application/json")

        echo "HTTP STATUS (drift results): $STATUS"
        cat drift_results.json || true
        jq '.' drift_results.json > drift_results_pretty.json || true

    # ------------------------ 11. PREPARE REPORTS ----------------
    - name: Prepare reports folder
      run: |
        mkdir -p reports
        cp -f oas_upload.json reports/ 2>/dev/null || true
        cp -f design_trigger.json reports/ 2>/dev/null || true
        cp -f design_results_pretty.json reports/ 2>/dev/null || true
        cp -f drift_trigger.json reports/ 2>/dev/null || true
        cp -f drift_results_pretty.json reports/ 2>/dev/null || true
        echo "Reports content:"
        ls -la reports || true

    # ------------------------ 12. COMMIT OAS + REPORTS -----------
    - name: Commit OAS & reports
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        branch: main
        commit_message: "Update OAS & Salt analysis results"
        file_pattern: |
          Fast-Store-API/backend/openapi.generated.json
          reports/*
        token: ${{ env.REPO_PAT }}
