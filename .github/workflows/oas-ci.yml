name: OAS Salt CI (final)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  BACKEND_DIR: Fast-Store-API/backend
  SALT_BASE: https://api.secured-api.com/v1
  SALT_TOKEN: ${{ secrets.SALT_API_TOKEN }}

jobs:
  salt-oas:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Install backend deps (if any)
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        if [ -f package.json ]; then
          npm ci || npm install
        fi

    - name: Install global tools
      run: npm install -g swagger-autogen glob

    # ---------- Generate OAS (absolute path) ----------
    - name: Generate OAS (absolute path, robust)
      id: gen
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        set -euo pipefail

        # absolute path where we want the generated file (rooted at workspace)
        OUTPUT="$GITHUB_WORKSPACE/${{ env.BACKEND_DIR }}/openapi.generated.json"
        echo "Will generate OAS at: $OUTPUT"

        mkdir -p scripts

        cat <<'EOF' > scripts/autogen.js
        const path = require('path');
        const glob = require('glob');
        const swaggerAutogen = require('swagger-autogen')();

        // absolute output path passed in via environment
        const outputFile = process.env.OUTPUT_PATH || path.join(process.cwd(), 'openapi.generated.json');

        const files = glob.sync("**/*.js", {
          ignore: ["node_modules/**", "scripts/**", "**/*.test.js"]
        });

        // heuristics
        const core = [];
        const pref = ["index.js","app.js","routes/index.js","routes.js"];
        for (const p of pref) {
          const f = files.find(x => x.endsWith(p));
          if (f) core.push("./" + f);
        }
        for (const f of files) {
          if (core.length >= 40) break;
          if (!core.includes("./" + f) && /route|router|express|app|index|server/.test(f)) {
            core.push("./" + f);
          }
        }
        if (core.length === 0) {
          const idx = files.find(f => f.endsWith("index.js"));
          if (idx) core.push("./" + idx);
        }

        console.log("Detected endpoint files:", core);
        console.log("Generating OAS ->", outputFile);

        const doc = { info: { title: "Fast Store API", description: "Autogenerated OAS" } };

        swaggerAutogen(outputFile, core, doc)
          .then(() => {
            console.log("swagger-autogen complete", outputFile);
            process.exit(0);
          })
          .catch(err => {
            console.error("swagger-autogen failed:", err && err.message ? err.message : err);
            process.exit(2);
          });
        EOF

        # run generator with explicit absolute output path
        export OUTPUT_PATH="$OUTPUT"
        node scripts/autogen.js

        # verify generated file exists and is readable
        if [ ! -f "$OUTPUT" ]; then
          echo "ERROR: Expected generated OAS not found at: $OUTPUT"
          echo "Workspace listing (for debugging):"
          ls -la "$GITHUB_WORKSPACE" || true
          ls -la "$GITHUB_WORKSPACE/${{ env.BACKEND_DIR }}" || true
          exit 2
        fi

        echo "Generated OAS file verified at: $OUTPUT"
        # set job output
        echo "oas_path=$OUTPUT" >> $GITHUB_OUTPUT

    # ---------- Confirm file exists (explicit) ----------
    - name: Debug â€” confirm OAS file
      run: |
        FILE="${{ steps.gen.outputs.oas_path }}"
        echo "OAS path (from output): $FILE"
        ls -la "$FILE" || (echo "File not found. Failing." && exit 2)
        echo "First 200 chars of OAS:"
        head -c 200 "$FILE" || true

    # ---------- Commit generated OAS to main ----------
    - name: Commit OAS to main
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Add autogenerated OAS"
        file_pattern: Fast-Store-API/backend/openapi.generated.json
        branch: main

    # ---------- Upload to Salt (multipart file[]), verbose ----------
    - name: Upload OAS to Salt
      id: upload
      run: |
        set -euo pipefail
        FILE="${{ steps.gen.outputs.oas_path }}"
        echo "Uploading file: $FILE"
        echo "curl will run and print verbose output (this is intentional for debugging)"

        curl -v -X POST "${{ env.SALT_BASE }}/oas/files" \
          -H "Authorization: Bearer ${{ env.SALT_TOKEN }}" \
          -H "accept: application/json" \
          -F "name=faststore-oas-${GITHUB_SHA::7}" \
          -F "file[]=@${FILE}" \
          -o oas_upload.json || (echo "curl failed; saved response (if any):"; cat oas_upload.json || true; exit 2)

        echo "Upload response:"
        cat oas_upload.json || true

        # extract OAS id robustly
        OAS_ID=$(jq -r '.oasId // .oasID // .id // .data.oasId // .data.id // empty' oas_upload.json)
        if [ -z "$OAS_ID" ]; then
          echo "ERROR: Could not extract oas id from upload response."
          echo "Full response:"
          cat oas_upload.json
          exit 2
        fi
        echo "oas_id=$OAS_ID" >> $GITHUB_OUTPUT

    # ---------- Trigger design analysis ----------
    - name: Trigger Design Analysis
      id: design
      run: |
        set -euo pipefail
        OAS_ID="${{ steps.upload.outputs.oas_id }}"
        echo "Triggering design analysis for oasId: $OAS_ID"
        curl -v -X POST "${{ env.SALT_BASE }}/oas/analyses/design?oasId=${OAS_ID}" \
          -H "Authorization: Bearer ${{ env.SALT_TOKEN }}" \
          -H "accept: application/json" \
          -d '{}' \
          -o design_trigger.json || (echo "design trigger failed"; cat design_trigger.json || true; exit 2)

        cat design_trigger.json
        DESIGN_ID=$(jq -r '.analysisId // .id // .data.analysisId // empty' design_trigger.json)
        echo "design_id=$DESIGN_ID" >> $GITHUB_OUTPUT

    # ---------- Poll design results (simple, 30 tries) ----------
    - name: Poll Design Results
      run: |
        set -euo pipefail
        ANALYSIS_ID="${{ steps.design.outputs.design_id }}"
        echo "Polling design analysis: $ANALYSIS_ID"
        for i in $(seq 1 30); do
          curl -s -H "Authorization: Bearer ${{ env.SALT_TOKEN }}" \
            "${{ env.SALT_BASE }}/oas/analyses/design/${ANALYSIS_ID}?limit=100&offset=0&statsOnly=false" \
            -o design_results.json || true
          # show tiny debug
          echo "Attempt $i: size $(wc -c < design_results.json || echo 0)"
          # break early if looks non-empty
          if [ -s design_results.json ]; then
            echo "Got design results"
            break
          fi
          sleep 5
        done
        jq '.' design_results.json > design_results_pretty.json || true

    # ---------- Trigger drift analysis (if apiId exists) ----------
    - name: Trigger Drift Analysis
      id: drift
      run: |
        set -euo pipefail
        OAS_ID="${{ steps.upload.outputs.oas_id }}"
        API_ID=$(jq -r '.apiId // .apiID // .data.apiId // empty' oas_upload.json || true)
        if [ -z "$API_ID" ]; then
          echo "No apiId in upload response; skipping drift trigger"
          echo "drift_id=" >> $GITHUB_OUTPUT
          exit 0
        fi
        echo "Triggering drift for apiId=$API_ID oasId=$OAS_ID"
        curl -v -X POST "${{ env.SALT_BASE }}/oas/analyses/drift?apiId=${API_ID}&oasId=${OAS_ID}" \
          -H "Authorization: Bearer ${{ env.SALT_TOKEN }}" \
          -H "accept: application/json" \
          -o drift_trigger.json || (echo "drift trigger failed"; cat drift_trigger.json || true; exit 2)

        cat drift_trigger.json
        DRIFT_ID=$(jq -r '.analysisId // .id // .data.analysisId // empty' drift_trigger.json)
        echo "drift_id=$DRIFT_ID" >> $GITHUB_OUTPUT

    # ---------- Fetch drift results ----------
    - name: Fetch Drift Results
      run: |
        set -euo pipefail
        DID="${{ steps.drift.outputs.drift_id }}"
        if [ -z "$DID" ]; then
          echo "No drift id - skipping fetch"
          exit 0
        fi
        curl -s -H "Authorization: Bearer ${{ env.SALT_TOKEN }}" \
          "${{ env.SALT_BASE }}/oas/analyses/drift/${DID}?apiId=${API_ID:-}&statsOnly=false" \
          -o drift_results.json || true
        jq '.' drift_results.json > drift_results_pretty.json || true

    # ---------- Package and commit reports ----------
    - name: Prepare & Commit Reports
      run: |
        mkdir -p reports
        cp -f oas_upload.json reports/ || true
        cp -f design_results_pretty.json reports/ || true
        cp -f drift_results_pretty.json reports/ || true
        ls -la reports || true

    - name: Commit Reports to reports branch
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Salt OAS analysis reports for ${{ github.sha }}"
        file_pattern: "reports/*"
        branch: reports
