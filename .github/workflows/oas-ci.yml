name: OAS-CI

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  BACKEND_DIR: Fast-Store-API/backend
  SALT_BASE: https://api.secured-api.com/v1
  NODE_VERSION: 18

jobs:
  oas-ci:
    runs-on: ubuntu-latest

    steps:

    # -----------------------------
    # CHECKOUT CODE
    # -----------------------------
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # -----------------------------
    # INSTALL NODE
    # -----------------------------
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    # -----------------------------
    # INSTALL BACKEND DEPENDENCIES
    # -----------------------------
    - name: Install backend dependencies
      working-directory: ${{ env.BACKEND_DIR }}
      run: npm ci

    # -----------------------------
    # INSTALL AUTOGEN TOOLS
    # -----------------------------
    - name: Install swagger-autogen + glob
      run: npm install -g swagger-autogen glob

    # -----------------------------
    # GENERATE OAS FILE INSIDE backend/
    # -----------------------------
    - name: Generate OAS automatically
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        echo "Running autodetect OAS generator..."
        node scripts/autodetect_generate_oas.js

        echo "Generated files:"
        ls -la .

        if [ ! -f openapi.generated.json ]; then
          echo "❌ ERROR: OAS not generated"
          exit 1
        fi

        echo "OAS generated successfully ✔"

    # -----------------------------
    # UPLOAD OAS TO SALT
    # -----------------------------
    - name: Upload OAS to Salt
      env:
        SALT_TOKEN: ${{ secrets.SALT_TOKEN }}
      run: |
        set -e
        OAS_FILE="${BACKEND_DIR}/openapi.generated.json"

        echo "Checking file exists:"
        ls -la "$OAS_FILE"

        echo "Uploading OAS: $OAS_FILE"

        curl -v -X POST "$SALT_BASE/oas/files" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -H "accept: application/json" \
          -F "name=faststore-oas" \
          -F "file[]=@${OAS_FILE}" \
          -o oas_upload.json

        echo "Salt Upload Response:"
        cat oas_upload.json

        OAS_ID=$(jq -r '.oasId // empty' oas_upload.json)
        if [ -z "$OAS_ID" ]; then
          echo "❌ ERROR: Could not parse oasId"
          exit 1
        fi

        echo "✔ OAS ID: $OAS_ID"
        echo "oas_id=$OAS_ID" >> $GITHUB_OUTPUT

    # -----------------------------
    # TRIGGER DESIGN ANALYSIS
    # -----------------------------
    - name: Trigger Design Analysis
      env:
        SALT_TOKEN: ${{ secrets.SALT_TOKEN }}
      run: |
        ANALYSIS=$(curl -s -X POST "$SALT_BASE/oas/analyses/design?oasId=${{ steps.Upload_OAS_to_Salt.outputs.oas_id }}" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -H "accept: application/json")

        echo "$ANALYSIS" > design_trigger.json
        ANALYSIS_ID=$(jq -r '.analysisId // empty' design_trigger.json)

        if [ -z "$ANALYSIS_ID" ]; then
          echo "❌ ERROR: Could not parse design analysisId"
          exit 1
        fi

        echo "design_id=$ANALYSIS_ID" >> $GITHUB_OUTPUT

    # -----------------------------
    # FETCH DESIGN ANALYSIS RESULTS
    # -----------------------------
    - name: Fetch Design Results
      env:
        SALT_TOKEN: ${{ secrets.SALT_TOKEN }}
      run: |
        curl -s "$SALT_BASE/oas/analyses/design/${{ steps.Trigger_Design_Analysis.outputs.design_id }}" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -H "accept: application/json" \
          -o design_results.json

        jq . design_results.json > design_results_pretty.json

    # -----------------------------
    # TRIGGER DRIFT ANALYSIS
    # -----------------------------
    - name: Trigger Drift Analysis
      env:
        SALT_TOKEN: ${{ secrets.SALT_TOKEN }}
        # You MUST set API_ID correctly in repo secrets
        API_ID: ${{ secrets.SALT_API_ID }}
      run: |
        DRIFT=$(curl -s -X POST "$SALT_BASE/oas/analyses/drift?apiId=$API_ID&oasId=${{ steps.Upload_OAS_to_Salt.outputs.oas_id }}" \
          -H "Authorization: Bearer $SALT_TOKEN")

        echo "$DRIFT" > drift_trigger.json
        DRIFT_ID=$(jq -r '.analysisId // empty' drift_trigger.json)

        if [ -z "$DRIFT_ID" ]; then
          echo "❌ ERROR: Could not parse drift analysisId"
          exit 1
        fi

        echo "drift_id=$DRIFT_ID" >> $GITHUB_OUTPUT

    # -----------------------------
    # FETCH DRIFT RESULTS
    # -----------------------------
    - name: Fetch Drift Results
      env:
        SALT_TOKEN: ${{ secrets.SALT_TOKEN }}
        API_ID: ${{ secrets.SALT_API_ID }}
      run: |
        curl -s "$SALT_BASE/oas/analyses/drift/${{ steps.Trigger_Drift_Analysis.outputs.drift_id }}?apiId=$API_ID" \
          -H "Authorization: Bearer $SALT_TOKEN" > drift_results.json

        jq . drift_results.json > drift_results_pretty.json

    # -----------------------------
    # PREPARE REPORTS FOLDER
    # -----------------------------
    - name: Prepare Reports
      run: |
        mkdir -p reports
        cp -f oas_upload.json reports/ || true
        cp -f design_results_pretty.json reports/ || true
        cp -f drift_results_pretty.json reports/ || true

    # -----------------------------
    # COMMIT OAS + REPORTS TO MAIN
    # -----------------------------
    - name: Commit OAS + Reports to main
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        branch: main
        commit_message: "Automated OAS + Salt Test Reports"
        file_pattern: |
          Fast-Store-API/backend/openapi.generated.json
          reports/*
      env:
        GIT_AUTHOR_NAME: github-actions
        GIT_AUTHOR_EMAIL: github-actions@github.com
        GIT_COMMITTER_NAME: github-actions
        GIT_COMMITTER_EMAIL: github-actions@github.com
        REPO_PAT: ${{ secrets.REPO_PAT }}

