name: OAS Salt CI

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

env:
  BACKEND_DIR: Fast-Store-API/backend
  SALT_BASE: https://api.secured-api.com/v1
  SALT_TOKEN: ${{ secrets.SALT_API_TOKEN }}

jobs:
  salt-oas:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    # -----------------------------
    # 1) Checkout
    # -----------------------------
    - name: Checkout Repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # -----------------------------
    # 2) Setup Node
    # -----------------------------
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    # -----------------------------
    # 3) Install backend deps
    # -----------------------------
    - name: Install backend dependencies
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        if [ -f package.json ]; then
          npm ci || npm install
        fi

    # -----------------------------
    # 4) Install swagger-autogen (if script needs it globally)
    # -----------------------------
    - name: Install swagger-autogen
      run: npm install -g swagger-autogen glob

    # -----------------------------
    # 5) Generate OAS using your backend script
    # -----------------------------
    - name: Generate OAS
      id: gen_oas
      working-directory: ${{ env.BACKEND_DIR }}
      run: |
        set -e

        echo "Running autodetect_generate_oas.js in $(pwd)"
        node scripts/autodetect_generate_oas.js

        # OAS should be generated here:
        OAS_REL="Fast-Store-API/backend/openapi.generated.json"
        OAS_ABS="$GITHUB_WORKSPACE/$OAS_REL"

        echo "Expecting OAS at: $OAS_ABS"

        if [ ! -f "$OAS_ABS" ]; then
          echo "ERROR: openapi.generated.json not found at $OAS_ABS"
          echo "Listing backend dir for debugging:"
          ls -la .
          exit 1
        fi

        ls -l "$OAS_ABS"
        echo "oas_path=$OAS_ABS" >> $GITHUB_OUTPUT

    # -----------------------------
    # 6) Commit OAS to main (pull -> merge -> push using PAT)
    # -----------------------------
    - name: Commit OAS to main
      env:
        REPO_PAT: ${{ secrets.REPO_PAT }}
      run: |
        set -e

        FILE="Fast-Store-API/backend/openapi.generated.json"

        git config user.email "action@github.com"
        git config user.name "GitHub Action"

        # Sync with remote to avoid non-fast-forward
        git pull origin main --no-edit || true

        git add "$FILE"
        # If nothing changed, don't fail
        git commit -m "Add autogenerated OAS" || echo "No OAS changes to commit"

        # Push using PAT
        git push "https://x-access-token:${REPO_PAT}@github.com/${{ github.repository }}.git" HEAD:main

    # -----------------------------
    # 7) Upload OAS to Salt
    # -----------------------------
    - name: Upload OAS to Salt
      id: upload_oas
      run: |
        set -e

        FILE="${{ steps.gen_oas.outputs.oas_path }}"
        echo "Uploading OAS file: $FILE"

        curl -v -X POST "$SALT_BASE/oas/files" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -H "accept: application/json" \
          -F "name=faststore-oas-${GITHUB_SHA::7}" \
          -F "file[]=@${FILE}" \
          -o oas_upload.json

        echo "Salt upload response:"
        cat oas_upload.json || true

        OAS_ID=$(jq -r '.oasId // .oasID // .id // .data.oasId // ""' oas_upload.json)
        if [ -z "$OAS_ID" ]; then
          echo "ERROR: Could not parse oasId from response"
          exit 1
        fi

        echo "Parsed OAS ID: $OAS_ID"
        echo "oas_id=$OAS_ID" >> $GITHUB_OUTPUT

    # -----------------------------
    # 8) Trigger Design Analysis
    # -----------------------------
    - name: Trigger Design Analysis
      id: design_trigger
      run: |
        set -e

        OAS_ID="${{ steps.upload_oas.outputs.oas_id }}"
        echo "Triggering design analysis for oasId=$OAS_ID"

        curl -s -X POST "$SALT_BASE/oas/analyses/design?oasId=$OAS_ID" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -H "accept: application/json" \
          -d '{}' \
          -o design_trigger.json

        echo "Design trigger response:"
        cat design_trigger.json || true

        DESIGN_ID=$(jq -r '.analysisId // .id // .data.analysisId // ""' design_trigger.json)
        if [ -z "$DESIGN_ID" ]; then
          echo "ERROR: Could not parse design analysisId"
          exit 1
        fi

        echo "design_id=$DESIGN_ID" >> $GITHUB_OUTPUT

    # -----------------------------
    # 9) Fetch Design Analysis Results
    # -----------------------------
    - name: Fetch Design Results
      run: |
        set -e

        DESIGN_ID="${{ steps.design_trigger.outputs.design_id }}"
        echo "Fetching design analysis results for id=$DESIGN_ID"

        curl -s "$SALT_BASE/oas/analyses/design/$DESIGN_ID?limit=0&offset=0&statsOnly=false" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -o design_results.json

        jq '.' design_results.json > design_results_pretty.json || true

    # -----------------------------
    # 10) Trigger Drift Analysis (best-effort)
    # -----------------------------
    - name: Trigger Drift Analysis
      id: drift_trigger
      run: |
        set -e

        OAS_ID="${{ steps.upload_oas.outputs.oas_id }}"
        # try to grab apiId from upload response if present
        API_ID=$(jq -r '.apiId // .apiID // .data.apiId // ""' oas_upload.json || true)

        if [ -z "$API_ID" ]; then
          echo "No apiId in upload response. Skipping drift analysis trigger."
          echo "drift_id=" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "Triggering drift analysis for apiId=$API_ID oasId=$OAS_ID"

        curl -s -X POST "$SALT_BASE/oas/analyses/drift?apiId=$API_ID&oasId=$OAS_ID" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -H "accept: application/json" \
          -d '{}' \
          -o drift_trigger.json

        echo "Drift trigger response:"
        cat drift_trigger.json || true

        DRIFT_ID=$(jq -r '.analysisId // .id // .data.analysisId // ""' drift_trigger.json)
        echo "drift_id=$DRIFT_ID" >> $GITHUB_OUTPUT

    # -----------------------------
    # 11) Fetch Drift Results (if any)
    # -----------------------------
    - name: Fetch Drift Results
      if: steps.drift_trigger.outputs.drift_id != ''
      run: |
        set -e

        DRIFT_ID="${{ steps.drift_trigger.outputs.drift_id }}"
        API_ID=$(jq -r '.apiId // .apiID // .data.apiId // ""' oas_upload.json || true)

        echo "Fetching drift results for analysisId=$DRIFT_ID apiId=$API_ID"

        curl -s "$SALT_BASE/oas/analyses/drift/$DRIFT_ID?apiId=$API_ID&statsOnly=false" \
          -H "Authorization: Bearer $SALT_TOKEN" \
          -o drift_results.json

        jq '.' drift_results.json > drift_results_pretty.json || true

    # -----------------------------
    # 12) Prepare reports folder
    # -----------------------------
    - name: Prepare Reports
      run: |
        mkdir -p reports
        cp -f oas_upload.json reports/ 2>/dev/null || true
        cp -f design_results_pretty.json reports/ 2>/dev/null || true
        cp -f drift_results_pretty.json reports/ 2>/dev/null || true
        echo "Reports directory content:"
        ls -la reports || true

    # -----------------------------
    # 13) Commit reports to 'reports' branch via PAT
    # -----------------------------
    - name: Commit Reports to reports branch
      env:
        REPO_PAT: ${{ secrets.REPO_PAT }}
      run: |
        set -e

        git config user.email "action@github.com"
        git config user.name "GitHub Action"

        git pull origin reports --no-edit || true
        git add reports/* || true
        git commit -m "Salt OAS analysis reports for ${{ github.sha }}" || echo "No report changes to commit"
        git push "https://x-access-token:${REPO_PAT}@github.com/${{ github.repository }}.git" HEAD:reports || true
